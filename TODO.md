# å‰åç«¯ä»£ç é—®é¢˜å®¡è®¡æŠ¥å‘Š

## è°ƒæŸ¥æ¦‚è¿°
åŸºäºå¯¹é¡¹ç›®ä»£ç çš„æ·±åº¦å®¡è®¡ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ã€‚æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç±»ã€‚

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ (éœ€è¦ç«‹å³ä¿®å¤)

### 1. å®‰å…¨é—®é¢˜

#### 1.1 ~~CORS é…ç½®è¿‡äºå®½æ¾~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/main.rs:85-113`
- ~~**é—®é¢˜**: ç”Ÿäº§ç¯å¢ƒå…è®¸ä»»æ„æ¥æºã€ä»»æ„æ–¹æ³•ã€ä»»æ„å¤´éƒ¨~~
- âœ… å·²æ”¹ä¸ºä»é…ç½®æ–‡ä»¶ `config.cors.*` è¯»å–ï¼Œæ”¯æŒç²¾ç¡®æ§åˆ¶

#### 1.2 ~~Fallback Token æœºåˆ¶ä¸å®‰å…¨~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/models/users/entities.rs:144-154`
- ~~**é—®é¢˜**: JWT ç”Ÿæˆå¤±è´¥æ—¶ä½¿ç”¨å¯é¢„æµ‹çš„ fallback token~~
- âœ… å·²ç§»é™¤ fallback æœºåˆ¶ï¼Œæ”¹ä¸ºç›´æ¥è¿”å› `Result<TokenPair, String>`

#### 1.3 ~~å‰ç«¯ Token å­˜å‚¨åœ¨ localStorage~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `frontend/src/stores/useUserStore.ts`
- ~~**é£é™©**: XSS æ”»å‡»å¯çªƒå– token~~
- âœ… Access Token æ”¹ä¸ºå­˜å‚¨åœ¨ Zustand å†…å­˜ store ä¸­
- âœ… é¡µé¢åˆ·æ–°åé€šè¿‡ httpOnly cookie çš„ refresh token è‡ªåŠ¨æ¢å¤
- âœ… ä¿®æ”¹äº† `api.ts`ã€`providers.tsx`ã€`useWebSocket.ts`ã€`fileService.ts` ç»Ÿä¸€ä» store è·å– token

#### 1.4 Token æš´éœ²åœ¨ WebSocket URL
- **æ–‡ä»¶**: `frontend/src/hooks/useWebSocket.ts:126-129`
- **é£é™©**: Token å¯èƒ½è¢«è®°å½•åœ¨æœåŠ¡å™¨æ—¥å¿—ã€ä»£ç†æ—¥å¿—æˆ–æµè§ˆå™¨å†å²ä¸­

#### 1.5 æ–‡ä»¶ä¸‹è½½ç¼ºå°‘ç»†ç²’åº¦æƒé™æ£€æŸ¥
- **æ–‡ä»¶**: `src/services/files/download.rs:11-16`
- **é—®é¢˜**: åªéªŒè¯ tokenï¼Œæ²¡æœ‰éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®è¯¥æ–‡ä»¶

### 2. API å®ç°é—®é¢˜

#### 2.1 ~~å‰ç«¯è°ƒç”¨äº†æœªå®ç°çš„æ–‡ä»¶åˆ é™¤ API~~ âœ… å·²å®ç°
- **è·¯ç”±**: `DELETE /api/v1/files/{file_token}`
- **æƒé™**: åªæœ‰ä¸Šä¼ è€…å¯ä»¥åˆ é™¤è‡ªå·±çš„æ–‡ä»¶
- **é€»è¾‘**: å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶åŒæ—¶åˆ é™¤ç‰©ç†æ–‡ä»¶

---

## ğŸŸ  ä¸­ç­‰é—®é¢˜

### 3. æ€§èƒ½é—®é¢˜

#### 3.1 N+1 æŸ¥è¯¢é—®é¢˜
- **æ•™å¸ˆç»Ÿè®¡**: `src/storage/sea_orm_storage/users.rs` - ~~å¾ªç¯ä¸­é€ä¸ªæŸ¥è¯¢ç­çº§å­¦ç”Ÿæ•°~~ âœ… å·²æ”¹ä¸º GROUP BY æ‰¹é‡æŸ¥è¯¢
- **ä½œä¸šåˆ—è¡¨åˆ›å»ºè€…æŸ¥è¯¢**: `src/storage/sea_orm_storage/homeworks.rs` - ~~å¾ªç¯é€ä¸ªæŸ¥è¯¢ç”¨æˆ·~~ âœ… å·²æ”¹ä¸º IN æ‰¹é‡æŸ¥è¯¢
- **ä½œä¸šç»Ÿè®¡ç­çº§å­¦ç”Ÿæ•°**: `src/storage/sea_orm_storage/homeworks.rs` - ~~å¾ªç¯é€ä¸ª COUNT~~ âœ… å·²æ”¹ä¸º GROUP BY æ‰¹é‡æŸ¥è¯¢ï¼ˆ2 å¤„ï¼‰
- **æäº¤è¯¦æƒ…é™„ä»¶æŸ¥è¯¢**: `src/storage/sea_orm_storage/submissions.rs` - ~~å¾ªç¯é€ä¸ªæŸ¥è¯¢æ–‡ä»¶~~ âœ… å·²æ”¹ä¸º IN æ‰¹é‡æŸ¥è¯¢
- **æäº¤æ¦‚è§ˆ**: `src/storage/sea_orm_storage/submissions.rs:443-448` - ~~å…ˆæŸ¥è¯¢æ‰€æœ‰æäº¤å†å†…å­˜èšåˆ~~ âœ… å·²æ”¹ä¸º GROUP BY æ•°æ®åº“èšåˆ + æ•°æ®åº“åˆ†é¡µ

#### 3.2 æ–‡ä»¶ä¸‹è½½å…¨é‡åŠ è½½
- **æ–‡ä»¶**: `src/services/files/download.rs`
- ~~**é—®é¢˜**: æ•´ä¸ªæ–‡ä»¶è¯»å…¥å†…å­˜ï¼Œå¤§æ–‡ä»¶ä¼š OOM~~
- âœ… å·²æ”¹ç”¨ `actix_files::NamedFile` æµå¼ä¼ è¾“ï¼Œæ”¯æŒ Range è¯·æ±‚ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰

#### 3.3 å‰ç«¯å¤§åˆ—è¡¨ä¸€æ¬¡æ€§åŠ è½½
- **æ–‡ä»¶**: `frontend/src/features/homework/components/HomeworkListCard.tsx`
- ~~**é—®é¢˜**: ä¸€æ¬¡æ€§åŠ è½½ 200 æ¡æ•°æ®åå‰ç«¯åˆ†é¡µ~~
- âœ… `TeacherHomeworksPage` ç­çº§åˆ—è¡¨ page_size 100â†’20ï¼Œ`useAllClassesHomeworks` page_size 100â†’50

### 4. é”™è¯¯å¤„ç†é—®é¢˜

#### 4.1 ~~expect/panic ä½¿ç”¨ä¸å½“~~ âœ… å·²ä¿®å¤
~~å¤šå¤„ä½¿ç”¨ `expect()` å¯èƒ½å¯¼è‡´æœåŠ¡å´©æºƒï¼š~~
- ~~`src/middlewares/require_jwt.rs:122, 142`~~
- ~~`src/routes/websocket.rs:52, 65`~~
- ~~`src/cache/object_cache/redis.rs:28`~~
- âœ… ä¸­é—´ä»¶/è·¯ç”±æ”¹ç”¨ `ok_or_else` è¿”å›é”™è¯¯
- âœ… Service å±‚ `get_storage` è¿”å› `Result<Arc<dyn Storage>, actix_web::Error>`

#### 4.2 ~~å‰ç«¯ç©º catch å—åæ‰é”™è¯¯~~ âœ… å·²ä¿®å¤
- ~~**æ–‡ä»¶**: `frontend/src/stores/useUserStore.ts:72-74, 111-112`~~
- ~~**é—®é¢˜**: å®Œå…¨åæ‰é”™è¯¯ï¼Œè¿æ—¥å¿—éƒ½æ²¡æœ‰~~
- âœ… åˆ›å»ºç»Ÿä¸€çš„ `src/lib/logger.ts` æ¨¡å—
- âœ… æ‰€æœ‰ catch å—æ·»åŠ  `logger.error` æˆ– `logger.warn`

### 5. ç±»å‹å®‰å…¨é—®é¢˜

#### 5.1 ~~è¿‡åº¦ä½¿ç”¨ç±»å‹æ–­è¨€~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `frontend/src/features/auth/services/auth.ts` ç­‰å¤šä¸ªæ–‡ä»¶
- ~~**é—®é¢˜**: å¤§é‡ä½¿ç”¨ `as unknown as Stringify<T>` æ–­è¨€~~
- âœ… ç§»é™¤äº† `Stringify<T>` ç±»å‹å·¥å…·å’Œæ‰€æœ‰ç›¸å…³æ–­è¨€
- âœ… ç›´æ¥ä½¿ç”¨ ts-rs ç”Ÿæˆçš„ç±»å‹ï¼ˆåç«¯å·²å°† i64 åºåˆ—åŒ–ä¸º stringï¼‰

#### 5.2 ~~bigint ç±»å‹è½¬æ¢ç²¾åº¦ä¸¢å¤±é£é™©~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `frontend/src/features/homework/services/homeworkService.ts:129`
- ~~**é—®é¢˜**: ts-rs å°† i64 ç”Ÿæˆä¸º bigintï¼ŒNumber è½¬æ¢ä¼šä¸¢ç²¾åº¦~~
- âœ… åç«¯æ‰€æœ‰ i64/u64 å­—æ®µç°åœ¨åºåˆ—åŒ–ä¸º stringï¼Œå‰ç«¯ç±»å‹å…¨éƒ¨ä¸º string
- âœ… ä½¿ç”¨ `#[serde(serialize_with = "serialize_i64_as_string")]` + `#[ts(type = "string")]`

### 6. æ–‡æ¡£ä¸ä¸€è‡´

#### 6.1 ~~API æ–‡æ¡£ä¸å®ç°ä¸åŒæ­¥~~ âœ… å·²ä¿®å¤
- ~~ç™»å‡º API: æ–‡æ¡£æ ‡æ³¨æœªå®ç° (`docs/API.md:243`)ï¼Œå®é™…å·²å®ç°~~
- ~~åˆ†é¡µå‚æ•°: æ–‡æ¡£ç”¨ `size`ï¼Œå®ç°ç”¨ `page_size`~~
- âœ… æ›´æ–°æ–‡æ¡£ç‰ˆæœ¬è‡³ v3.0
- âœ… ç§»é™¤ç™»å‡º API çš„"æœªå®ç°"æ ‡è®°
- âœ… ç»Ÿä¸€åˆ†é¡µå‚æ•°ä¸º `page_size`
- âœ… æ›´æ–°æ–‡ä»¶åˆ é™¤ API æ–‡æ¡£ï¼ˆè·¯å¾„æ”¹ä¸º `/files/{token}`ï¼Œæ·»åŠ å®Œæ•´è¯´æ˜ï¼‰

### 7. ç”¨æˆ·ä½“éªŒé—®é¢˜

#### 7.1 ~~æ‰¹é‡åˆ é™¤æ— ç¡®è®¤å¯¹è¯æ¡†~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `frontend/src/features/admin/pages/UserListPage.tsx`
- âœ… æ·»åŠ äº† AlertDialog ç¡®è®¤å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºè¦åˆ é™¤çš„ç”¨æˆ·æ•°é‡

#### 7.2 ~~åŠ è½½çŠ¶æ€ä¸ä¸€è‡´~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `frontend/src/app/router.tsx`
- ~~ç¡¬ç¼–ç  "Loading..." æœªå›½é™…åŒ–~~
- âœ… å·²æ”¹ç”¨ `t("common.loading")` å›½é™…åŒ–

---

## ğŸŸ¡ ä½ä¼˜å…ˆçº§é—®é¢˜

### 8. ä»£ç è´¨é‡

#### 8.1 é‡å¤ä»£ç 
- ~~Storage è·å–æ¨¡å¼åœ¨æ‰€æœ‰ Service ä¸­é‡å¤~~ âœ… å·²æå– `StorageProvider` trait
- ~~é˜²æŠ–æœç´¢æ¨¡å¼åœ¨å¤šä¸ªç»„ä»¶ä¸­é‡å¤ (`ClassListPage`, `UserListPage`, `HomeworkListCard`)~~ âœ… å·²åˆ›å»º `useDebouncedSearch` hook
- ~~å¸ƒå±€ç»„ä»¶é‡å¤ (`NotificationLayout`, `SettingsLayout`)~~ âœ… å·²åˆ›å»º `useRoleNavItems` hook å’Œ `RoleBasedLayout` ç»„ä»¶

#### 8.2 ç»„ä»¶è¿‡å¤§ - âœ… å·²å®Œæˆ
- `UserListPage.tsx`: ~~485 è¡Œ~~ â†’ 404 è¡Œ (æå–äº† `useBatchSelection` hook å’Œ `UserListFilters` ç»„ä»¶)
- `HomeworkDetailPage.tsx`: ~~451 è¡Œ~~ â†’ 275 è¡Œ âœ… (æå–äº† `useHomeworkStatus` hookã€`HomeworkInfoCard`ã€`MySubmissionCard`ã€`SubmissionManagementCard` ç»„ä»¶)
- `HomeworkListCard.tsx`: ~~260 è¡Œ~~ â†’ 158 è¡Œ âœ… (æå–äº† `useHomeworkFilters` hookã€`HomeworkListToolbar` å’Œ `HomeworkStatusTabs` ç»„ä»¶)

#### 8.3 ~~é­”æ³•æ•°å­—~~ âœ… å·²ä¿®å¤
- ~~`frontend/src/lib/api.ts:47`: `timeout: 10000`~~
- ~~`frontend/src/features/class/pages/ClassListPage.tsx:44`: `pageSize = 12`~~
- âœ… å·²åˆ›å»º `frontend/src/lib/constants.ts` é›†ä¸­ç®¡ç†å¸¸é‡

### 9. å¯è®¿é—®æ€§é—®é¢˜

#### 9.1 ~~ç¼ºå°‘ ARIA æ ‡ç­¾~~ âœ… å·²ä¿®å¤
- ~~**æ–‡ä»¶**: `frontend/src/features/auth/pages/LoginPage.tsx:116-128`~~
- ~~å¯†ç å¯è§æ€§åˆ‡æ¢æŒ‰é’®æ—  `aria-label`~~
- âœ… å·²æ·»åŠ  `aria-label` å±æ€§å’Œ i18n é”®

#### 9.2 ~~é¢œè‰²å¯¹æ¯”åº¦ä¾èµ–~~ âœ… éé—®é¢˜
- **æ–‡ä»¶**: `frontend/src/features/admin/pages/UserListPage.tsx:53-65`
- ~~è§’è‰²å’ŒçŠ¶æ€ä»…é€šè¿‡é¢œè‰²åŒºåˆ†~~
- âœ… ç»å®¡æŸ¥ï¼Œä»£ç å·²æ­£ç¡®ä½¿ç”¨æ–‡å­—æ ‡ç­¾é…åˆé¢œè‰²ï¼ˆç¬¦åˆ WCAG 1.4.1ï¼‰

### 10. é…ç½®é—®é¢˜

#### 10.1 ~~JWT Secret ç¡¬ç¼–ç é»˜è®¤å€¼~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `config.toml:37`
- ~~`secret = "default_secret_key"` æœªåœ¨é»‘åå•ä¸­~~
- âœ… å·²åœ¨ `src/config/impl.rs` çš„ `validate_security()` é»‘åå•ä¸­æ·»åŠ  `"default_secret_key"`

#### 10.2 ~~Argon2 é…ç½®æœªä½¿ç”¨~~ âœ… å·²ä¿®å¤
- ~~**é…ç½®**: `config.toml` ä¸­å®šä¹‰äº† Argon2 é…ç½®~~
- ~~**å®é™…**: `src/services/auth/register.rs:115-122` ä½¿ç”¨ `Argon2::default()`~~
- âœ… å·²åˆ é™¤å±€éƒ¨ `hash_password` å‡½æ•°ï¼Œæ”¹ç”¨ `crate::utils::password::hash_password`

---

## é—®é¢˜ç»Ÿè®¡

| ä¸¥é‡ç¨‹åº¦ | æ€»æ•° | å·²ä¿®å¤ | å‰©ä½™ |
|---------|------|--------|------|
| ğŸ”´ ä¸¥é‡ | 6 | 4 | 2 |
| ğŸŸ  ä¸­ç­‰ | 10 | 10 | 0 |
| ğŸŸ¡ ä½ | 8 | 8 | 0 |

---

## å»ºè®®ä¿®å¤é¡ºåº

1. **ç¬¬ä¸€ä¼˜å…ˆçº§ - å®‰å…¨ä¿®å¤**
   - [x] ä¿®å¤ CORS é…ç½®
   - [x] ç§»é™¤ fallback token æœºåˆ¶
   - [x] ä¿®å¤ JWT Secret é»‘åå•éªŒè¯
   - [x] ä¿®å¤ Argon2 é…ç½®æœªä½¿ç”¨
   - [x] Token å­˜å‚¨æ–¹æ¡ˆæ”¹è¿›ï¼ˆAccess Token å­˜å†…å­˜ï¼ŒRefresh Token ç”¨ httpOnly cookieï¼‰
   - [ ] ä¿®å¤æ–‡ä»¶ä¸‹è½½æƒé™æ£€æŸ¥

2. **ç¬¬äºŒä¼˜å…ˆçº§ - åŠŸèƒ½ä¿®å¤**
   - [x] å®ç°æ–‡ä»¶åˆ é™¤ API
   - [x] æ›´æ–° API æ–‡æ¡£

3. **ç¬¬ä¸‰ä¼˜å…ˆçº§ - æ€§èƒ½ä¼˜åŒ–**
   - [x] ä¿®å¤ N+1 æŸ¥è¯¢ï¼ˆ6 å¤„å…¨éƒ¨ä¿®å¤ï¼‰
   - [x] å®ç°æµå¼æ–‡ä»¶ä¸‹è½½ï¼ˆNamedFile + Range æ”¯æŒï¼‰
   - [x] å‰ç«¯åˆ†é¡µå‚æ•°ä¼˜åŒ–ï¼ˆpage_size è°ƒæ•´ï¼‰

4. **ç¬¬å››ä¼˜å…ˆçº§ - ä»£ç è´¨é‡**
   - [x] æå–é˜²æŠ–æœç´¢é‡å¤ä»£ç ï¼ˆ`useDebouncedSearch` hookï¼‰
   - [x] æå–é­”æ³•æ•°å­—ä¸ºå¸¸é‡ï¼ˆ`constants.ts`ï¼‰
   - [x] æ·»åŠ  ARIA å¯è®¿é—®æ€§æ ‡ç­¾
   - [x] æå– Storage è·å–é‡å¤ä»£ç ï¼ˆ`StorageProvider` traitï¼‰
   - [x] æ‹†åˆ†è¿‡å¤§ç»„ä»¶
     - [x] æå– `useBatchSelection` é€šç”¨ hook
     - [x] æå– `useHomeworkFilters` hook
     - [x] æå– `useHomeworkStatus` hook
     - [x] æå– `UserListFilters` ç»„ä»¶
     - [x] æå– `HomeworkListToolbar` ç»„ä»¶
     - [x] æå– `HomeworkStatusTabs` ç»„ä»¶
     - [x] æå– `HomeworkInfoCard` ç»„ä»¶
     - [x] æå– `MySubmissionCard` ç»„ä»¶
     - [x] æå– `SubmissionManagementCard` ç»„ä»¶
   - [ ] å¸ƒå±€ç»„ä»¶é‡å¤

---

## åç«¯æ€§èƒ½æ·±åº¦å®¡è®¡ (2026-01-31)

åŸºäºå¯¹ storage / services / cache / middlewares å››å±‚çš„å…¨é¢å®¡è®¡ï¼Œå‘ç°ä»¥ä¸‹æ€§èƒ½é—®é¢˜ã€‚

---

### ğŸ”´ ä¸¥é‡é—®é¢˜

#### P1. ~~é™æµå™¨ç«æ€æ¡ä»¶ï¼ˆå¯ç»•è¿‡ï¼‰~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/middlewares/rate_limit.rs:248-263`
- ~~**é—®é¢˜**: `get` å’Œ `insert` ä¹‹é—´ä¸æ˜¯åŸå­æ“ä½œï¼Œå¹¶å‘è¯·æ±‚å¯åŒæ—¶è¯»åˆ°ç›¸åŒè®¡æ•°å€¼å†å„è‡ª +1ï¼Œå¯¼è‡´å®é™…æ”¾è¡Œè¯·æ±‚è¿œè¶…é™åˆ¶~~
- ~~**å½±å“**: å®‰å…¨é—®é¢˜ï¼Œé™æµå½¢åŒè™šè®¾ã€‚10 ä¸ªå¹¶å‘è¯·æ±‚åœ¨ limit=5 æ—¶å¯èƒ½å…¨éƒ¨æ”¾è¡Œ~~
- âœ… å·²æ”¹ä¸º `Cache<String, Arc<AtomicU32>>`ï¼Œä½¿ç”¨ `get_with()` åŸå­è·å–æˆ–åˆ›å»ºè®¡æ•°å™¨ï¼Œ`fetch_add` åŸå­é€’å¢

#### P2. ~~ç­çº§å¯¼å‡ºæŠ¥è¡¨ N+1 æŸ¥è¯¢ï¼ˆä¸‰å±‚åµŒå¥—ï¼‰~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/services/classes/export.rs:170-278`
- ~~**é—®é¢˜**:~~
  - ~~å¤–å±‚ï¼šå¯¹æ¯ä¸ªä½œä¸šè°ƒç”¨ `list_all_submissions_by_homework`ï¼ˆN æ¬¡æŸ¥è¯¢ï¼‰~~
  - ~~å†…å±‚ï¼šå¯¹æ¯ä¸ªæäº¤è°ƒç”¨ `get_grade_by_submission_id`ï¼ˆM æ¬¡æŸ¥è¯¢ï¼‰~~
  - ~~å†å¯¹æ¯ä¸ªå­¦ç”Ÿè°ƒç”¨ `get_user_by_id`ï¼ˆK æ¬¡æŸ¥è¯¢ï¼‰~~
- ~~**å½±å“**: 30 äººç­çº§ 10 ä¸ªä½œä¸š â†’ çº¦ 340+ æ¬¡æ•°æ®åº“æŸ¥è¯¢~~
- âœ… å·²æ–°å¢ 3 ä¸ªæ‰¹é‡æ–¹æ³•å¹¶æ”¹ç”¨æ‰¹é‡æŸ¥è¯¢ï¼š
  - `list_all_submissions_by_homework_ids` â€” ä¸€æ¬¡æŸ¥è¯¢æ‰€æœ‰ä½œä¸šçš„æäº¤
  - `get_grades_by_submission_ids` â€” ä¸€æ¬¡æŸ¥è¯¢æ‰€æœ‰è¯„åˆ†
  - `get_users_by_ids` â€” ä¸€æ¬¡æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
- âœ… æŸ¥è¯¢æ•°é‡ä» ~340 æ¬¡é™ä¸º 4 æ¬¡

#### P3. ~~ä½œä¸šåˆ—è¡¨åˆ›å»ºè€… N+1 æŸ¥è¯¢ï¼ˆstorage å±‚æ®‹ç•™ï¼‰~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/storage/sea_orm_storage/homeworks.rs:854-875`
- ~~**é—®é¢˜**: `list_all_homeworks_impl` ä¸­å¾ªç¯é€ä¸ªæŸ¥è¯¢ creator ç”¨æˆ·ä¿¡æ¯~~
- âœ… å·²æ”¹ä¸º `UserColumn::Id.is_in(creator_ids)` æ‰¹é‡æŸ¥è¯¢ï¼ˆä¸ç¬¬ 140-165 è¡Œæ¨¡å¼ä¸€è‡´ï¼‰

---

### ğŸŸ  é«˜ä¼˜å…ˆçº§

#### P4. ~~å¤šå¤„å†™æ“ä½œç¼ºå°‘äº‹åŠ¡ä¿æŠ¤~~ âœ… å·²ä¿®å¤
- ~~`src/storage/sea_orm_storage/homeworks.rs:36-68` â€” åˆ›å»ºä½œä¸š + å…³è”é™„ä»¶ä¸åœ¨åŒä¸€äº‹åŠ¡~~
- ~~`src/storage/sea_orm_storage/homeworks.rs:364-416` â€” æ›´æ–°ä½œä¸š + é™„ä»¶åŒç†~~
- ~~`src/storage/sea_orm_storage/submissions.rs:34-98` â€” åˆ›å»ºæäº¤ + å…³è”é™„ä»¶~~
- ~~`src/storage/sea_orm_storage/grades.rs:22-50` â€” åˆ›å»ºè¯„åˆ† + æ›´æ–°æäº¤çŠ¶æ€~~
- ~~`src/storage/sea_orm_storage/system_settings.rs:41-88` â€” æ›´æ–°è®¾ç½® + å®¡è®¡æ—¥å¿—~~
- ~~**å½±å“**: ä»»ä¸€æ­¥å¤±è´¥ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´~~
- âœ… å·²ä½¿ç”¨ `db.begin()` + `commit()` äº‹åŠ¡åŒ…è£¹æ‰€æœ‰å¤šæ­¥å†™æ“ä½œ
- âœ… æ–°å¢ `*_txn` ç‰ˆæœ¬æ–¹æ³•æ”¯æŒäº‹åŠ¡å‚æ•°ä¼ é€’

#### P5. ~~JWT é‡å¤è§£ç ~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/middlewares/require_jwt.rs:115-149`
- ~~**é—®é¢˜**: å…ˆè°ƒ `verify_access_token()` éªŒç­¾ï¼ˆå†…éƒ¨å·²è§£ç ï¼‰ï¼Œå†è°ƒ `decode_token()` é‡æ–°è§£ç ã€‚ä¸¤æ¬¡å®Œæ•´è§£ç ~~
- âœ… ä¿å­˜ `verify_access_token()` è¿”å›çš„ Claimsï¼Œåœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶ç›´æ¥ä½¿ç”¨
- âœ… æ¯ä¸ªè¯·æ±‚åªæ‰§è¡Œä¸€æ¬¡ JWT è§£ç 

#### P6. ~~ç­çº§è§’è‰²ä¸­é—´ä»¶æ¯è¯·æ±‚æŸ¥æ•°æ®åº“~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/middlewares/require_class_role.rs:225-242`
- ~~**é—®é¢˜**: `RequireClassRole` ä¸­é—´ä»¶æ— ç¼“å­˜ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æŸ¥ `class_user` è¡¨~~
- ~~**å½±å“**: ç­çº§ç›¸å…³æ¥å£åœ¨é«˜å¹¶å‘ä¸‹äº§ç”Ÿå¤§é‡é‡å¤æŸ¥è¯¢~~
- âœ… æ·»åŠ ç­çº§æˆå‘˜è§’è‰²ç¼“å­˜ï¼ˆTTL 300ç§’ï¼‰
- âœ… åœ¨ join/update/leave ç­çº§æ—¶ä¸»åŠ¨å¤±æ•ˆç¼“å­˜

#### P7. ~~Moka ç¼“å­˜å¿½ç•¥å•é¡¹ TTL~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/cache/object_cache/moka.rs:49-58`
- ~~**é—®é¢˜**: `insert_raw` çš„ `ttl` å‚æ•°è¢«å®Œå…¨å¿½ç•¥ï¼Œæ‰€æœ‰ç¼“å­˜é¡¹ä½¿ç”¨å…¨å±€ TTL~~
- âœ… ä½¿ç”¨ Moka `Expiry` trait å®ç°æŒ‰é¡¹ TTL
- âœ… `ttl=0` ä½¿ç”¨é»˜è®¤ TTLï¼Œ`ttl>0` ä½¿ç”¨æŒ‡å®šå€¼

#### P8. ~~payload é™åˆ¶ä¸ä¸Šä¼ é™åˆ¶å†²çª~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `config.example.toml`
- ~~**é—®é¢˜**: `max_payload_size = 1MB`ï¼Œä½† `upload.max_size = 10MB`ï¼Œå¤§æ–‡ä»¶ä¸Šä¼ ä¼šè¢«å…¨å±€ payload é™åˆ¶ç›´æ¥æ‹’ç»~~
- âœ… ä¸ºæ–‡ä»¶ä¸Šä¼ è·¯ç”± `/api/v1/files/upload` å•ç‹¬é…ç½® `PayloadConfig`
- âœ… ä¸ºç”¨æˆ·å¯¼å…¥è·¯ç”± `/api/v1/users/import` å•ç‹¬é…ç½® `PayloadConfig`

---

### ğŸŸ¡ ä¸­ç­‰ä¼˜å…ˆçº§

#### P9. ~~Services å±‚å¤šå¤„é¡ºåºæŸ¥è¯¢åº”æ”¹ä¸ºæ‰¹é‡~~ âœ… å·²ä¿®å¤
| æ–‡ä»¶ | è¡Œå· | é—®é¢˜ | çŠ¶æ€ |
|------|------|------|------|
| `src/services/classes/list.rs` | 126-153 | ~~å¾ªç¯æŸ¥æ•™å¸ˆä¿¡æ¯~~ | âœ… æ”¹ç”¨ `get_users_by_ids` æ‰¹é‡æŸ¥è¯¢ |
| `src/services/homeworks/stats.rs` | 155-160 | ~~å¾ªç¯æŸ¥æ¯ä¸ªæäº¤çš„è¯„åˆ†~~ | âœ… æ”¹ç”¨ `get_grades_by_submission_ids` æ‰¹é‡æŸ¥è¯¢ |
| `src/services/homeworks/stats.rs` | 189-201 | ~~å¾ªç¯æŸ¥æœªæäº¤å­¦ç”Ÿçš„ç”¨æˆ·ä¿¡æ¯~~ | âœ… æ”¹ç”¨ `get_users_by_ids` æ‰¹é‡æŸ¥è¯¢ |
| `src/services/homeworks/detail.rs` | 56-70 | ~~å¾ªç¯æŸ¥æ–‡ä»¶ä¿¡æ¯~~ | âœ… æ–°å¢ `get_files_by_ids` å¹¶ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ |
| `src/services/notifications/trigger.rs` | 88-100 | æ¯æ¬¡å‘é€šçŸ¥éƒ½æŸ¥ç­çº§å­¦ç”Ÿåˆ—è¡¨ | â¸ï¸ é N+1 é—®é¢˜ï¼Œæ— éœ€ä¿®å¤ |

#### P10. ~~Storage æ›´æ–°æ“ä½œé‡å¤æŸ¥è¯¢~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/storage/sea_orm_storage/users.rs:172-221`
- ~~**é—®é¢˜**: æ›´æ–°å‰æŸ¥ä¸€æ¬¡ç¡®è®¤å­˜åœ¨ï¼Œæ›´æ–°ååˆæŸ¥ä¸€æ¬¡è¿”å›ã€‚`update()` æœ¬èº«è¿”å›æ›´æ–°åæ•°æ®~~
- ~~**åŒæ ·é—®é¢˜**: `classes.rs:122-156`ã€`grades.rs:76-110`~~
- âœ… ä¸‰å¤„å‡å·²æ”¹ä¸ºç›´æ¥ä½¿ç”¨ `update()` è¿”å›çš„ Model æ„é€ ç»“æœ

#### P11. ~~æ‰¹é‡é€šçŸ¥é€æ¡æ’å…¥~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/storage/sea_orm_storage/notifications.rs:46-76`
- ~~**é—®é¢˜**: å¾ªç¯ä¸­é€æ¡ `insert`~~
- âœ… å·²æ”¹ç”¨ SeaORM `insert_many` æ‰¹é‡æ’å…¥ï¼ˆäº‹åŠ¡ä¿æŠ¤ï¼‰

#### P12. ~~ä½œä¸šåˆ—è¡¨å†…å­˜ä¸­å…¨é‡è¿‡æ»¤åˆ†é¡µ~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/storage/sea_orm_storage/homeworks.rs:746-764`
- ~~**é—®é¢˜**: å…ˆæŸ¥å‡ºæ‰€æœ‰ä½œä¸šåˆ°å†…å­˜ï¼Œåœ¨åº”ç”¨å±‚åšçŠ¶æ€è¿‡æ»¤å’Œåˆ†é¡µ~~
- ~~**å½±å“**: æ•°æ®é‡å¤§æ—¶å†…å­˜æ¶ˆè€—é«˜~~
- âœ… ä½¿ç”¨ EXISTS/NOT EXISTS å­æŸ¥è¯¢å°†çŠ¶æ€è¿‡æ»¤ä¸‹æ¨åˆ° SQL å±‚
- âœ… æ”¹ç”¨ `paginate()` + `fetch_page()` æ•°æ®åº“åˆ†é¡µ
- âœ… åªå¯¹åˆ†é¡µåçš„ä½œä¸šæŸ¥è¯¢æäº¤/è¯„åˆ†ä¿¡æ¯ï¼Œå‡å°‘å†…å­˜æ¶ˆè€—

#### P13. ~~`Cache-Control: no-cache` å…¨å±€ç¦ç”¨æµè§ˆå™¨ç¼“å­˜~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/main.rs:117-123`
- ~~**é—®é¢˜**: æ‰€æœ‰å“åº”ï¼ˆåŒ…æ‹¬å‰ç«¯é™æ€èµ„æº JS/CSS/å›¾ç‰‡ï¼‰éƒ½åŠ äº† `no-cache, no-store, must-revalidate`~~
- ~~**å½±å“**: æ¯æ¬¡é¡µé¢åŠ è½½éƒ½é‡æ–°æ‹‰å–æ‰€æœ‰é™æ€èµ„æº~~
- âœ… API ä¿æŒ `no-cache`ï¼ˆå…¨å±€ DefaultHeadersï¼‰
- âœ… æ–‡ä»¶ä¸‹è½½æ¥å£è®¾ç½® `Cache-Control: private, max-age=31536000, immutable`
- âœ… å‰ç«¯é™æ€èµ„æºå·²åœ¨ `frontend.rs` ä¸­æœ‰ç‹¬ç«‹ç¼“å­˜ç­–ç•¥

#### P14. ~~æ•°æ®åº“è¿æ¥æ± å¯èƒ½ä¸è¶³~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/config/impl.rs:54-62`
- ~~**é—®é¢˜**: `pool_size = 10`ï¼Œä½† `max_workers` å¯è¾¾ 32ã€‚é«˜å¹¶å‘æ—¶è¿æ¥æ± æˆä¸ºç“¶é¢ˆ~~
- âœ… å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹ `pool_size < workers`ï¼Œè‡ªåŠ¨è°ƒæ•´ä¸º `max(workers, 10)` å¹¶è¾“å‡ºè­¦å‘Š

#### P15. ~~XLSX å¯¼å‡ºé˜»å¡è¯·æ±‚çº¿ç¨‹~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/services/classes/export.rs:343-387`
- ~~**é—®é¢˜**: XLSX æ–‡ä»¶ç”Ÿæˆåœ¨ Actix worker çº¿ç¨‹åŒæ­¥æ‰§è¡Œï¼Œå¤§æ•°æ®é‡æ—¶é˜»å¡çº¿ç¨‹~~
- âœ… ä½¿ç”¨ `actix_web::web::block` å°† XLSX ç”Ÿæˆç§»åˆ°çº¿ç¨‹æ± æ‰§è¡Œï¼Œé¿å…é˜»å¡ worker

---

### ğŸ”µ ä½ä¼˜å…ˆçº§

#### P16. ~~JWT ç¼“å­˜é”®ä½¿ç”¨å®Œæ•´ token å­—ç¬¦ä¸²~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/middlewares/require_jwt.rs:139`
- ~~**é—®é¢˜**: JWT token é•¿åº¦ 200-500+ å­—ç¬¦ï¼Œä½œä¸ºç¼“å­˜ key æµªè´¹å†…å­˜~~
- âœ… ä½¿ç”¨ `DefaultHasher` å¯¹ token è¿›è¡Œ hashï¼Œç¼“å­˜ key ä» `user:{token}` æ”¹ä¸º `user:jwt:{hash_16ä½}`

#### P17. ~~JWT Secret æ¯æ¬¡æ“ä½œéƒ½ clone~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/utils/jwt.rs:7-17`
- ~~**é—®é¢˜**: `get_secret()` æ¯æ¬¡éƒ½ clone String å¹¶é‡æ–°æ„å»º `DecodingKey`/`EncodingKey`~~
- âœ… ä½¿ç”¨ `OnceLock` ç¼“å­˜ `EncodingKey` å’Œ `DecodingKey`ï¼Œåªåœ¨é¦–æ¬¡è°ƒç”¨æ—¶æ„å»º

#### P18. é™æµå™¨å›ºå®šçª—å£ç®—æ³•
- **æ–‡ä»¶**: `src/middlewares/rate_limit.rs:46-51`
- **é—®é¢˜**: å›ºå®šçª—å£é™æµåœ¨çª—å£è¾¹ç•Œå…è®¸ 2x burst
- **å»ºè®®**: æ”¹ç”¨æ»‘åŠ¨çª—å£æˆ–ä»¤ç‰Œæ¡¶ç®—æ³•

#### P19. é™æµå™¨ hot path å¤šæ¬¡å­—ç¬¦ä¸²åˆ†é…
- **æ–‡ä»¶**: `src/middlewares/rate_limit.rs:237-245`
- **é—®é¢˜**: æ¯ä¸ªè¯·æ±‚å¤šæ¬¡ `format!` åˆ›å»ºæ–° String
- **å»ºè®®**: é¢„åˆ†é…æˆ–ä½¿ç”¨ `write!` åˆ° buffer

#### P20. åŠ¨æ€é…ç½®æ¯æ¬¡è¯»å–åŠ  RwLock + clone
- **æ–‡ä»¶**: `src/services/system/settings_cache.rs:54-60`
- **é—®é¢˜**: é¢‘ç¹è¯»å–çš„é…ç½®æ¯æ¬¡éƒ½è¦è·å–è¯»é”å¹¶ clone String
- **å»ºè®®**: ä½¿ç”¨ `DashMap` æˆ– `Arc<str>` å‡å°‘é”ç«äº‰å’Œåˆ†é…

#### P21. ç¼“å­˜æ³¨å†Œè¡¨ä½¿ç”¨ RwLockï¼ˆä»…å¯åŠ¨æ—¶ç”¨ï¼‰
- **æ–‡ä»¶**: `src/cache/register.rs:15-32`
- **é—®é¢˜**: æ³¨å†Œè¡¨ä»…åœ¨å¯åŠ¨æ—¶å†™å…¥ï¼Œè¿è¡Œæ—¶åªè¯»ï¼ŒRwLock å¤šä½™
- **å»ºè®®**: æ”¹ç”¨ `OnceLock` æˆ– `LazyLock`

---

### æ€§èƒ½é—®é¢˜ç»Ÿè®¡

| ä¸¥é‡ç¨‹åº¦ | æ•°é‡ | å·²ä¿®å¤ | é—®é¢˜ç¼–å· |
|---------|------|--------|---------|
| ğŸ”´ ä¸¥é‡ | 3 | 3 | P1 âœ…, P2 âœ…, P3 âœ… |
| ğŸŸ  é«˜ | 5 | 5 | P4 âœ…, P5 âœ…, P6 âœ…, P7 âœ…, P8 âœ… |
| ğŸŸ¡ ä¸­ | 7 | 7 | P9 âœ…, P10 âœ…, P11 âœ…, P12 âœ…, P13 âœ…, P14 âœ…, P15 âœ… |
| ğŸ”µ ä½ | 6 | 2 | P16 âœ…, P17 âœ…, P18-P21 |

### å»ºè®®ä¿®å¤é¡ºåº

1. **ç¬¬ä¸€æ‰¹ â€” å®‰å…¨ + æ•°æ®å®Œæ•´æ€§**
   - [x] P1: é™æµå™¨ç«æ€ä¿®å¤ âœ…
   - [x] P4: äº‹åŠ¡ä¿æŠ¤ âœ…

2. **ç¬¬äºŒæ‰¹ â€” é«˜é¢‘è·¯å¾„ä¼˜åŒ–**
   - [x] P5: JWT å»é‡è§£ç  âœ…
   - [x] P6: ä¸­é—´ä»¶ç¼“å­˜ âœ…
   - [x] P7: Moka æŒ‰é¡¹ TTL âœ…
   - [x] P8: payload é™åˆ¶ä¿®æ­£ âœ…

3. **ç¬¬ä¸‰æ‰¹ â€” æŸ¥è¯¢ä¼˜åŒ–**
   - [x] P2: å¯¼å‡ºæŠ¥è¡¨ N+1 âœ…
   - [x] P3: ä½œä¸šåˆ—è¡¨ N+1 âœ…
   - [x] P9: Services å±‚æ‰¹é‡åŒ– âœ…
   - [x] P10: Storage æ›´æ–°å»é‡å¤æŸ¥è¯¢ âœ…
   - [x] P11: æ‰¹é‡é€šçŸ¥ insert_many âœ…
   - [x] P12: æ•°æ®åº“å±‚åˆ†é¡µ âœ…

4. **ç¬¬å››æ‰¹ â€” è¿è¡Œæ—¶ä¼˜åŒ–**
   - [x] P13: Cache-Control åˆ†å±‚è®¾ç½® âœ…
   - [x] P14: æ•°æ®åº“è¿æ¥æ± åŠ¨æ€è°ƒæ•´ âœ…
   - [x] P15: XLSX çº¿ç¨‹æ± æ‰§è¡Œ âœ…

---

## éªŒè¯æ–¹å¼

ä¿®å¤åéœ€è¦éªŒè¯ï¼š
1. è¿è¡Œæ‰€æœ‰åç«¯æµ‹è¯•: `cargo test`
2. è¿è¡Œå‰ç«¯æµ‹è¯•: `cd frontend && npm test`
3. æ‰‹åŠ¨æµ‹è¯•æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½/åˆ é™¤æµç¨‹
4. ä½¿ç”¨ OWASP ZAP æˆ–ç±»ä¼¼å·¥å…·è¿›è¡Œå®‰å…¨æ‰«æ
5. æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒ CORS é…ç½®æ˜¯å¦æ­£ç¡®
6. å¯¹ N+1 ä¿®å¤é¡¹è¿›è¡Œ SQL æ—¥å¿—å¯¹æ¯”éªŒè¯ï¼ˆä¿®å¤å‰åæŸ¥è¯¢æ•°é‡ï¼‰
7. ä½¿ç”¨ `wrk` æˆ– `hey` å¯¹é™æµå™¨è¿›è¡Œå¹¶å‘å‹æµ‹
