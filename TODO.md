# å‰åç«¯ä»£ç é—®é¢˜å®¡è®¡æŠ¥å‘Š

## è°ƒæŸ¥æ¦‚è¿°
åŸºäºå¯¹é¡¹ç›®ä»£ç çš„æ·±åº¦å®¡è®¡ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ã€‚æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç±»ã€‚

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ (éœ€è¦ç«‹å³ä¿®å¤)

### 1. å®‰å…¨é—®é¢˜

#### 1.1 ~~CORS é…ç½®è¿‡äºå®½æ¾~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/main.rs:85-113`
- ~~**é—®é¢˜**: ç”Ÿäº§ç¯å¢ƒå…è®¸ä»»æ„æ¥æºã€ä»»æ„æ–¹æ³•ã€ä»»æ„å¤´éƒ¨~~
- âœ… å·²æ”¹ä¸ºä»é…ç½®æ–‡ä»¶ `config.cors.*` è¯»å–ï¼Œæ”¯æŒç²¾ç¡®æ§åˆ¶

#### 1.2 ~~Fallback Token æœºåˆ¶ä¸å®‰å…¨~~ âœ… å·²ä¿®å¤
- **æ–‡ä»¶**: `src/models/users/entities.rs:144-154`
- ~~**é—®é¢˜**: JWT ç”Ÿæˆå¤±è´¥æ—¶ä½¿ç”¨å¯é¢„æµ‹çš„ fallback token~~
- âœ… å·²ç§»é™¤ fallback æœºåˆ¶ï¼Œæ”¹ä¸ºç›´æ¥è¿”å› `Result<TokenPair, String>`

#### 1.3 å‰ç«¯ Token å­˜å‚¨åœ¨ localStorage
- **æ–‡ä»¶**: `frontend/src/stores/useUserStore.ts:39-43`
- **é£é™©**: XSS æ”»å‡»å¯çªƒå– token

#### 1.4 Token æš´éœ²åœ¨ WebSocket URL
- **æ–‡ä»¶**: `frontend/src/hooks/useWebSocket.ts:126-129`
- **é£é™©**: Token å¯èƒ½è¢«è®°å½•åœ¨æœåŠ¡å™¨æ—¥å¿—ã€ä»£ç†æ—¥å¿—æˆ–æµè§ˆå™¨å†å²ä¸­

#### 1.5 æ–‡ä»¶ä¸‹è½½ç¼ºå°‘ç»†ç²’åº¦æƒé™æ£€æŸ¥
- **æ–‡ä»¶**: `src/services/files/download.rs:11-16`
- **é—®é¢˜**: åªéªŒè¯ tokenï¼Œæ²¡æœ‰éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®è¯¥æ–‡ä»¶

### 2. API å®ç°é—®é¢˜

#### 2.1 ~~å‰ç«¯è°ƒç”¨äº†æœªå®ç°çš„æ–‡ä»¶åˆ é™¤ API~~ âœ… å·²å®ç°
- **è·¯ç”±**: `DELETE /api/v1/files/{file_token}`
- **æƒé™**: åªæœ‰ä¸Šä¼ è€…å¯ä»¥åˆ é™¤è‡ªå·±çš„æ–‡ä»¶
- **é€»è¾‘**: å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶åŒæ—¶åˆ é™¤ç‰©ç†æ–‡ä»¶

---

## ğŸŸ  ä¸­ç­‰é—®é¢˜

### 3. æ€§èƒ½é—®é¢˜

#### 3.1 N+1 æŸ¥è¯¢é—®é¢˜
- **æ•™å¸ˆç»Ÿè®¡**: `src/storage/sea_orm_storage/users.rs` - ~~å¾ªç¯ä¸­é€ä¸ªæŸ¥è¯¢ç­çº§å­¦ç”Ÿæ•°~~ âœ… å·²æ”¹ä¸º GROUP BY æ‰¹é‡æŸ¥è¯¢
- **ä½œä¸šåˆ—è¡¨åˆ›å»ºè€…æŸ¥è¯¢**: `src/storage/sea_orm_storage/homeworks.rs` - ~~å¾ªç¯é€ä¸ªæŸ¥è¯¢ç”¨æˆ·~~ âœ… å·²æ”¹ä¸º IN æ‰¹é‡æŸ¥è¯¢
- **ä½œä¸šç»Ÿè®¡ç­çº§å­¦ç”Ÿæ•°**: `src/storage/sea_orm_storage/homeworks.rs` - ~~å¾ªç¯é€ä¸ª COUNT~~ âœ… å·²æ”¹ä¸º GROUP BY æ‰¹é‡æŸ¥è¯¢ï¼ˆ2 å¤„ï¼‰
- **æäº¤è¯¦æƒ…é™„ä»¶æŸ¥è¯¢**: `src/storage/sea_orm_storage/submissions.rs` - ~~å¾ªç¯é€ä¸ªæŸ¥è¯¢æ–‡ä»¶~~ âœ… å·²æ”¹ä¸º IN æ‰¹é‡æŸ¥è¯¢
- **æäº¤æ¦‚è§ˆ**: `src/storage/sea_orm_storage/submissions.rs:443-448` - å…ˆæŸ¥è¯¢æ‰€æœ‰æäº¤å†å†…å­˜èšåˆï¼ˆæš‚ç¼“ï¼Œéœ€è¾ƒå¤§é‡æ„ï¼‰

#### 3.2 æ–‡ä»¶ä¸‹è½½å…¨é‡åŠ è½½
- **æ–‡ä»¶**: `src/services/files/download.rs`
- ~~**é—®é¢˜**: æ•´ä¸ªæ–‡ä»¶è¯»å…¥å†…å­˜ï¼Œå¤§æ–‡ä»¶ä¼š OOM~~
- âœ… å·²æ”¹ç”¨ `actix_files::NamedFile` æµå¼ä¼ è¾“ï¼Œæ”¯æŒ Range è¯·æ±‚ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰

#### 3.3 å‰ç«¯å¤§åˆ—è¡¨ä¸€æ¬¡æ€§åŠ è½½
- **æ–‡ä»¶**: `frontend/src/features/homework/components/HomeworkListCard.tsx`
- ~~**é—®é¢˜**: ä¸€æ¬¡æ€§åŠ è½½ 200 æ¡æ•°æ®åå‰ç«¯åˆ†é¡µ~~
- âœ… `TeacherHomeworksPage` ç­çº§åˆ—è¡¨ page_size 100â†’20ï¼Œ`useAllClassesHomeworks` page_size 100â†’50

### 4. é”™è¯¯å¤„ç†é—®é¢˜

#### 4.1 expect/panic ä½¿ç”¨ä¸å½“
å¤šå¤„ä½¿ç”¨ `expect()` å¯èƒ½å¯¼è‡´æœåŠ¡å´©æºƒï¼š
- `src/middlewares/require_jwt.rs:122, 142`
- `src/routes/websocket.rs:52, 65`
- `src/cache/object_cache/redis.rs:28`

#### 4.2 å‰ç«¯ç©º catch å—åæ‰é”™è¯¯
- **æ–‡ä»¶**: `frontend/src/stores/useUserStore.ts:72-74, 111-112`
- **é—®é¢˜**: å®Œå…¨åæ‰é”™è¯¯ï¼Œè¿æ—¥å¿—éƒ½æ²¡æœ‰

### 5. ç±»å‹å®‰å…¨é—®é¢˜

#### 5.1 è¿‡åº¦ä½¿ç”¨ç±»å‹æ–­è¨€
- **æ–‡ä»¶**: `frontend/src/features/auth/services/auth.ts:22, 27, 54`
```typescript
return response.data.data! as unknown as Stringify<LoginResponse>;
```

#### 5.2 bigint ç±»å‹è½¬æ¢ç²¾åº¦ä¸¢å¤±é£é™©
- **æ–‡ä»¶**: `frontend/src/features/homework/services/homeworkService.ts:129`
```typescript
Number(classId)  // class_id æ˜¯ bigintï¼ŒNumber ä¼šä¸¢ç²¾åº¦
```

### 6. æ–‡æ¡£ä¸ä¸€è‡´

#### 6.1 API æ–‡æ¡£ä¸å®ç°ä¸åŒæ­¥
- ç™»å‡º API: æ–‡æ¡£æ ‡æ³¨æœªå®ç° (`docs/API.md:243`)ï¼Œå®é™…å·²å®ç°
- åˆ†é¡µå‚æ•°: æ–‡æ¡£ç”¨ `size`ï¼Œå®ç°ç”¨ `page_size`

### 7. ç”¨æˆ·ä½“éªŒé—®é¢˜

#### 7.1 æ‰¹é‡åˆ é™¤æ— ç¡®è®¤å¯¹è¯æ¡†
- **æ–‡ä»¶**: `frontend/src/features/admin/pages/UserListPage.tsx:147-159`

#### 7.2 åŠ è½½çŠ¶æ€ä¸ä¸€è‡´
- **æ–‡ä»¶**: `frontend/src/app/router.tsx:71-77`
- ç¡¬ç¼–ç  "Loading..." æœªå›½é™…åŒ–

---

## ğŸŸ¡ ä½ä¼˜å…ˆçº§é—®é¢˜

### 8. ä»£ç è´¨é‡

#### 8.1 é‡å¤ä»£ç 
- Storage è·å–æ¨¡å¼åœ¨æ‰€æœ‰ Service ä¸­é‡å¤
- é˜²æŠ–æœç´¢æ¨¡å¼åœ¨å¤šä¸ªç»„ä»¶ä¸­é‡å¤ (`ClassListPage`, `UserListPage`, `HomeworkListCard`)
- å¸ƒå±€ç»„ä»¶é‡å¤ (`NotificationLayout`, `SettingsLayout`)

#### 8.2 ç»„ä»¶è¿‡å¤§
- `UserListPage.tsx`: 485 è¡Œ
- `HomeworkDetailPage.tsx`: 451 è¡Œ
- `HomeworkListCard.tsx`: 260 è¡Œ

#### 8.3 é­”æ³•æ•°å­—
- `frontend/src/lib/api.ts:47`: `timeout: 10000`
- `frontend/src/features/class/pages/ClassListPage.tsx:44`: `pageSize = 12`

### 9. å¯è®¿é—®æ€§é—®é¢˜

#### 9.1 ç¼ºå°‘ ARIA æ ‡ç­¾
- **æ–‡ä»¶**: `frontend/src/features/auth/pages/LoginPage.tsx:116-128`
- å¯†ç å¯è§æ€§åˆ‡æ¢æŒ‰é’®æ—  `aria-label`

#### 9.2 é¢œè‰²å¯¹æ¯”åº¦ä¾èµ–
- **æ–‡ä»¶**: `frontend/src/features/admin/pages/UserListPage.tsx:53-65`
- è§’è‰²å’ŒçŠ¶æ€ä»…é€šè¿‡é¢œè‰²åŒºåˆ†

### 10. é…ç½®é—®é¢˜

#### 10.1 JWT Secret ç¡¬ç¼–ç é»˜è®¤å€¼
- **æ–‡ä»¶**: `config.toml:37`
```toml
secret = "default_secret_key"
```

#### 10.2 Argon2 é…ç½®æœªä½¿ç”¨
- **é…ç½®**: `config.toml` ä¸­å®šä¹‰äº† Argon2 é…ç½®
- **å®é™…**: `src/services/auth/register.rs:115-122` ä½¿ç”¨ `Argon2::default()`

---

## é—®é¢˜ç»Ÿè®¡

| ä¸¥é‡ç¨‹åº¦ | æ•°é‡ | ç±»åˆ« |
|---------|------|------|
| ğŸ”´ ä¸¥é‡ | 6 | å®‰å…¨ã€API ç¼ºå¤± |
| ğŸŸ  ä¸­ç­‰ | 10 | æ€§èƒ½ã€é”™è¯¯å¤„ç†ã€ç±»å‹å®‰å…¨ã€æ–‡æ¡£ã€UX |
| ğŸŸ¡ ä½ | 8 | ä»£ç è´¨é‡ã€å¯è®¿é—®æ€§ã€é…ç½® |

---

## å»ºè®®ä¿®å¤é¡ºåº

1. **ç¬¬ä¸€ä¼˜å…ˆçº§ - å®‰å…¨ä¿®å¤**
   - [x] ä¿®å¤ CORS é…ç½®
   - [x] ç§»é™¤ fallback token æœºåˆ¶
   - [ ] ä¿®å¤æ–‡ä»¶ä¸‹è½½æƒé™æ£€æŸ¥
   - [ ] è€ƒè™‘ token å­˜å‚¨æ–¹æ¡ˆæ”¹è¿›

2. **ç¬¬äºŒä¼˜å…ˆçº§ - åŠŸèƒ½ä¿®å¤**
   - [x] å®ç°æ–‡ä»¶åˆ é™¤ API
   - [ ] æ›´æ–° API æ–‡æ¡£

3. **ç¬¬ä¸‰ä¼˜å…ˆçº§ - æ€§èƒ½ä¼˜åŒ–**
   - [x] ä¿®å¤ N+1 æŸ¥è¯¢ï¼ˆ5 å¤„å·²ä¿®å¤ï¼Œ1 å¤„æš‚ç¼“ï¼‰
   - [x] å®ç°æµå¼æ–‡ä»¶ä¸‹è½½ï¼ˆNamedFile + Range æ”¯æŒï¼‰
   - [x] å‰ç«¯åˆ†é¡µå‚æ•°ä¼˜åŒ–ï¼ˆpage_size è°ƒæ•´ï¼‰

4. **ç¬¬å››ä¼˜å…ˆçº§ - ä»£ç è´¨é‡**
   - [ ] æå–é‡å¤ä»£ç 
   - [ ] æ‹†åˆ†è¿‡å¤§ç»„ä»¶
   - [ ] æ”¹è¿›é”™è¯¯å¤„ç†

---

## éªŒè¯æ–¹å¼

ä¿®å¤åéœ€è¦éªŒè¯ï¼š
1. è¿è¡Œæ‰€æœ‰åç«¯æµ‹è¯•: `cargo test`
2. è¿è¡Œå‰ç«¯æµ‹è¯•: `cd frontend && npm test`
3. æ‰‹åŠ¨æµ‹è¯•æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½/åˆ é™¤æµç¨‹
4. ä½¿ç”¨ OWASP ZAP æˆ–ç±»ä¼¼å·¥å…·è¿›è¡Œå®‰å…¨æ‰«æ
5. æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒ CORS é…ç½®æ˜¯å¦æ­£ç¡®
